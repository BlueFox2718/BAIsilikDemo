<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>B.AI.silik</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&display=swap" rel="stylesheet">
<link rel="manifest" href="/BAIsilikDemo/manifest.json">
<meta name="theme-color" content="#0088FF">

<style>
:root { --futur-color:#0088FF; }
*{ box-sizing:border-box; }
html,body{
  height:100%; margin:0;
  font-family:'Orbitron',sans-serif;
  background:#fff; color:var(--futur-color);
}
body{
  display:flex; flex-direction:column;
  align-items:center;
  padding:env(safe-area-inset-top) 10px 10px;
  overflow:auto;
}

h1{
  font-size:2rem; margin:10px 0 20px;
  user-select:none;
}

button{
  background:transparent;
  border:2px solid var(--futur-color);
  color:var(--futur-color);
  padding:12px 24px;
  border-radius:8px;
  cursor:pointer;
  font-size:16px;
}
button:hover{ background:var(--futur-color); color:#000; }

/* Conteneurs camÃ©ra */
#cameraContainer{
  display:none;
  flex-direction:column;
  align-items:center;
  margin-top:10px;
  width:100%;
  max-width:920px;
}

#photoFrame{
  position:relative;
  width:100%;
  max-width:920px;
  margin:20px auto;
  border:2px solid var(--futur-color);
  border-radius:12px;
  overflow:hidden;
  background:#000;
}

video, canvas{
  width:100%;
  height:100%;
  object-fit:contain;
}

/* Overlay scan */
#scanOverlay{
  position:absolute;
  inset:0;
  pointer-events:none;
  display:none;
  z-index:4;
}
#scanOverlay .line{
  position:absolute;
  background:#00FFFF;
  opacity:.5;
}

#scanText{
  display:none;
  margin-top:8px;
  font-size:1.2rem;
}

#resultBox{
  display:none;
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background:#fff;
  color:#000;
  padding:12px 16px;
  border-radius:10px;
  z-index:6;
  max-width:90%;
  text-align:center;
  cursor:pointer;
}

/* MENU SECRET */
#secretModal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.65);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:20;
}

#secretBox{
  background:#fff;
  color:#000;
  padding:20px;
  width:90%;
  max-width:420px;
  border-radius:12px;
  text-align:center;
}

#secretText{
  width:100%;
  height:150px;
  resize:none;
  padding:10px;
  border:2px solid var(--futur-color);
  border-radius:8px;
  font-family:inherit;
}

.modalButtons{
  margin-top:15px;
  display:flex;
  gap:10px;
  justify-content:center;
  flex-wrap:wrap;
}
</style>
</head>

<body>

<h1 id="title">B.AI.silik</h1>
<button id="startBtn">Prendre une photo</button>

<!-- MENU SECRET -->
<div id="secretModal">
  <div id="secretBox">
    <h3>Message personnalisÃ©</h3>

    <div style="display:flex; gap:6px; justify-content:center; margin-bottom:6px;">
      <button id="custom1">Custom 1</button>
      <button id="custom2">Custom 2</button>
      <button id="custom3">Custom 3</button>
    </div>

    <div style="display:flex; gap:6px; justify-content:center; margin-bottom:10px;">
      <button id="btnCarte">Carte</button>
      <button id="btnPiece">PiÃ¨ce</button>
      <button id="btnMain">Main</button>
    </div>

    <textarea id="secretText"></textarea>

    <div class="modalButtons">
      <button id="cancelSecret">Annuler</button>
      <button id="saveCustom" style="display:none;">Sauvegarder</button>
      <button id="validateSecret">Valider</button>
    </div>
  </div>
</div>

<div id="cameraContainer">
  <div style="margin:12px 0; display:flex; gap:10px;">
    <button id="captureBtn">Capturer</button>
    <button id="switchCamBtn">ðŸ“·ðŸ”„</button>
    <button id="analyzeBtn" style="display:none;">Analyser</button>
  </div>

  <div id="scanText">Analyse en cours</div>

  <div id="photoFrame">
    <canvas id="canvas" style="display:none;"></canvas>
    <video id="video" autoplay playsinline></video>
    <div id="scanOverlay"></div>
    <div id="resultBox"></div>
  </div>
</div>

<script>
/* ===================== IA ===================== */
const defaultResponse = "La photo montre un magicien rÃ©aliser un tour de magie";
const presets = {
  carte: "La photo montre un magicien rÃ©aliser un tour de carte. Il y a 95.6% de chance que la carte choisie soit l'As de carreau.",
  piece: "La photo montre un magicien rÃ©aliser un tour de piÃ¨ce. Mais il y a 96.4% de chance pour qu'il dÃ©cide de faire un tour de carte. Il y a alors 93.1% de chance que la carte choisie soit le 2 de carreau.",
  main: "La photo montre une main."
};

let Reponse_IA = localStorage.getItem("secretMessage") || defaultResponse;
let activePreset = null;

/* ===================== MENU SECRET ===================== */
const modal = document.getElementById("secretModal");
const textarea = document.getElementById("secretText");
const saveBtn = document.getElementById("saveCustom");

(function(){
  let c=0,t;
  document.getElementById("title").onclick=()=>{
    c++;
    if(c===2){
      clearTimeout(t);
      c=0;
      textarea.value = Reponse_IA;
      modal.style.display="flex";
    } else t=setTimeout(()=>c=0,300);
  };
})();

cancelSecret.onclick = ()=> modal.style.display="none";

validateSecret.onclick = ()=>{
  const txt = textarea.value.trim() || defaultResponse;
  Reponse_IA = txt;
  localStorage.setItem("secretMessage", txt);
  modal.style.display="none";
};

function selectPreset(name){
  activePreset = name;
  textarea.value = presets[name];
  saveBtn.style.display="none";
}
btnCarte.onclick = ()=>selectPreset("carte");
btnPiece.onclick = ()=>selectPreset("piece");
btnMain.onclick  = ()=>selectPreset("main");

function selectCustom(n){
  activePreset = "custom"+n;
  textarea.value = localStorage.getItem(activePreset+"Message") || defaultResponse;
  saveBtn.style.display="inline-block";
}
custom1.onclick = ()=>selectCustom(1);
custom2.onclick = ()=>selectCustom(2);
custom3.onclick = ()=>selectCustom(3);

saveBtn.onclick = ()=>{
  if(activePreset?.startsWith("custom")){
    localStorage.setItem(activePreset+"Message", textarea.value.trim());
  }
};

/* ===================== CAMÃ‰RA ===================== */
const startBtn=document.getElementById('startBtn');
const captureBtn=document.getElementById('captureBtn');
const switchCamBtn=document.getElementById('switchCamBtn');
const analyzeBtn=document.getElementById('analyzeBtn');
const cameraContainer=document.getElementById('cameraContainer');
const video=document.getElementById('video');
const canvas=document.getElementById('canvas');
const photoFrame=document.getElementById('photoFrame');
const scanOverlay=document.getElementById('scanOverlay');
const scanText=document.getElementById('scanText');
const resultBox=document.getElementById('resultBox');

let stream=null, usingFrontCam=false;

async function startCamera(){
  if(stream) stream.getTracks().forEach(t=>t.stop());
  stream=await navigator.mediaDevices.getUserMedia({
    video:{facingMode:{ideal:usingFrontCam?"user":"environment"}},
    audio:false
  });
  video.srcObject=stream;
  video.onloadedmetadata=()=>{
    canvas.width=video.videoWidth;
    canvas.height=video.videoHeight;
  };
}

startBtn.onclick=async()=>{
  cameraContainer.style.display="flex";
  startBtn.remove();
  await startCamera();
};

switchCamBtn.onclick=async()=>{
  usingFrontCam=!usingFrontCam;
  await startCamera();
};

captureBtn.onclick=()=>{
  canvas.getContext("2d").drawImage(video,0,0,canvas.width,canvas.height);
  canvas.style.display="block";
  video.style.display="none";
  captureBtn.style.display="none";
  switchCamBtn.style.display="none";
  analyzeBtn.style.display="inline-block";
};

analyzeBtn.onclick=()=>{
  analyzeBtn.remove();
  scanText.style.display="block";
  scanOverlay.style.display="block";
  startScan(()=>{ scanOverlay.innerHTML=""; scanText.style.display="none"; typeText(Reponse_IA); });
};

function startScan(done){
  const dirs=["down","up","right","left"]; let i=0;
  function next(){
    if(i>=dirs.length) return done();
    scanOverlay.innerHTML="";
    const l=document.createElement("div"); l.className="line"; scanOverlay.appendChild(l);
    let a;
    if(dirs[i]==="down"){l.style.width="100%";l.style.height="6px";a=l.animate([{top:"0%"},{top:"100%"}],800);}
    if(dirs[i]==="up"){l.style.width="100%";l.style.height="6px";l.style.top="100%";a=l.animate([{top:"100%"},{top:"0%"}],800);}
    if(dirs[i]==="right"){l.style.height="100%";l.style.width="6px";a=l.animate([{left:"0%"},{left:"100%"}],800);}
    if(dirs[i]==="left"){l.style.height="100%";l.style.width="6px";l.style.left="100%";a=l.animate([{left:"100%"},{left:"0%"}],800);}
    i++; a.onfinish=next;
  }
  next();
}

function typeText(t){
  resultBox.style.display="block";
  resultBox.textContent="";
  let i=0;
  (function step(){
    if(i<t.length){ resultBox.textContent+=t[i++]; setTimeout(step,40); }
  })();
}

resultBox.onclick=()=>{
  const a=document.createElement("a");
  a.href=canvas.toDataURL("image/png");
  a.download=Date.now()+".png";
  a.click();
};
</script>

<script>
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("/BAIsilikDemo/sw.js");
}
</script>

</body>
</html>

