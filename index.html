<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>B.AI.silik</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&display=swap" rel="stylesheet">
<link rel="manifest" href="/BAIsilikDemo/manifest.json">
<meta name="theme-color" content="#0088FF">

<style>
:root { --futur-color:#0088FF; }
*{ box-sizing:border-box; }
html,body{
  height:100%; margin:0;
  font-family:'Orbitron',sans-serif;
  background:#fff; color:var(--futur-color);
}
body{
  display:flex; flex-direction:column;
  align-items:center;
  padding:env(safe-area-inset-top) 10px 10px;
  overflow:auto;
}

h1{
  font-size:2rem; margin:10px 0 20px;
  user-select:none;
}

button{
  background:transparent;
  border:2px solid var(--futur-color);
  color:var(--futur-color);
  padding:12px 24px;
  border-radius:8px;
  cursor:pointer;
  font-size:16px;
}
button:hover{ background:var(--futur-color); color:#000; }

/* Conteneurs */
#cameraContainer{
  display:none; flex-direction:column;
  align-items:center;
  margin-top:10px;
  width:100%; max-width:920px;
}

#photoFrame{
  position:relative;
  width:100%; max-width:920px;
  margin:20px auto;
  border:2px solid var(--futur-color);
  border-radius:12px;
  overflow:hidden;
  background:#000;
  display:block;
}

video, canvas{
  display:block; width:100%; height:100%;
  object-fit:contain;
}

/* Overlay scan + IA */
#scanOverlay{
  position:absolute; top:0; left:0;
  width:100%; height:100%;
  pointer-events:none; display:none;
  z-index:4;
}
#scanOverlay .line{
  position:absolute;
  background:#00FFFF; opacity:.5;
}

#scanText{
  display:none;
  margin-top:8px;
  font-size:1.2rem;
  white-space:pre;
}

#resultBox{
  display:none;
  position:absolute;
  top:50%; left:50%;
  transform:translate(-50%,-50%);
  background:#fff; color:#000;
  padding:12px 16px;
  border-radius:10px;
  z-index:6; max-width:90%;
  text-align:center;
  cursor:pointer;
}

/* --- MENU SECRET --- */
#secretModal{
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.65);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:20;
}

#secretBox{
  background:white; color:black;
  padding:20px;
  width:90%; max-width:400px;
  border-radius:12px;
  text-align:center;
}

#secretText{
  width:100%;
  height:150px;
  resize:none;
  padding:10px;
  font-family:inherit;
  border:2px solid var(--futur-color);
  border-radius:8px;
  font-size:14px;
}

.modalButtons{
  margin-top:15px;
  display:flex;
  gap:10px;
  justify-content:center;
}

@media (max-width:600px){
  h1{ font-size:1.6rem; }
  button{ padding:10px 18px; }
}
</style>
</head>

<body>

<h1 id="title">B.AI.silik</h1>
<button id="startBtn">Prendre une photo</button>

<!-- MENU SECRET -->
<div id="secretModal">
  <div id="secretBox">
    <h3>Message personnalisÃ©</h3>

    <div style="display:flex; gap:8px; justify-content:center; margin-bottom:10px;">
      <button id="btnCarte" style="padding:6px 12px;">Carte</button>
      <button id="btnPiece" style="padding:6px 12px;">PiÃ¨ce</button>
      <button id="btnMain"  style="padding:6px 12px;">Main</button>
    </div>

    <textarea id="secretText"></textarea>

    <div class="modalButtons">
      <button id="cancelSecret">Annuler</button>
      <button id="validateSecret">Valider</button>
    </div>
  </div>
</div>

<div id="cameraContainer">

  <div style="margin:12px 0; display:flex; gap:10px;">
    <button id="captureBtn">Capturer</button>
    <button id="switchCamBtn" title="Changer de camÃ©ra">ðŸ“·ðŸ”„</button>
    <button id="analyzeBtn" style="display:none;">Analyser</button>
  </div>

  <div id="scanText">Analyse en cours</div>

  <div id="photoFrame" aria-live="polite">
    <canvas id="canvas" style="display:none;"></canvas>
    <video id="video" autoplay playsinline></video>
    <div id="scanOverlay"></div>
    <div id="resultBox"></div>
  </div>
</div>

<script>
/* ------------------------------------------
        VARIABLE IA
-------------------------------------------*/
let defaultResponse = "La photo montre un magicien rÃ©aliser un tour de magie";
let Response_carte = "La photo montre un magicien rÃ©aliser un tour de carte. Il y a 95.6% de chance que la carte choisie soit l'As de carreau.";
let Response_piece = "La photo montre un magicien rÃ©aliser un tour de piÃ¨ce. Mais il y a 96.4% de chance pour qu'il dÃ©cide de faire un tour de carte. Il y a alors 91.3% de chance pour que la carte choisie soit le 2 de carreau.";
let Response_main = "La photo montre une main.";
let Reponse_IA = defaultResponse;

/* ------------------------------------------
                MENU SECRET
-------------------------------------------*/
const title = document.getElementById("title");
const modal = document.getElementById("secretModal");
const textareaSecret = document.getElementById("secretText");
const cancelSecret = document.getElementById("cancelSecret");
const validateSecret = document.getElementById("validateSecret");

let clickCount = 0;
let clickTimer = null;

const saved = localStorage.getItem("secretMessage");
if (saved && saved.trim() !== "") {
    Reponse_IA = saved;
}

title.addEventListener("click", () => {
  clickCount++;
  if (clickCount === 1){
    clickTimer = setTimeout(() => { clickCount = 0; }, 300);
  } else if (clickCount === 2){
    clearTimeout(clickTimer);
    clickCount = 0;
    textareaSecret.value = Reponse_IA;
    modal.style.display = "flex";
  }
});

cancelSecret.addEventListener("click", () => modal.style.display = "none");

validateSecret.addEventListener("click", () => {
  const txt = textareaSecret.value.trim();
  if (txt !== "") {
      Reponse_IA = txt;
      localStorage.setItem("secretMessage", txt);
  }
  modal.style.display = "none";
});

document.getElementById("btnCarte").onclick = ()=> textareaSecret.value = Response_carte;
document.getElementById("btnPiece").onclick = ()=> textareaSecret.value = Response_piece;
document.getElementById("btnMain").onclick  = ()=> textareaSecret.value = Response_main;

/* ------------------------------------------
                CAMÃ‰RA + SWITCH
-------------------------------------------*/
const startBtn = document.getElementById('startBtn');
const captureBtn = document.getElementById('captureBtn');
const switchCamBtn = document.getElementById('switchCamBtn');
const analyzeBtn = document.getElementById('analyzeBtn');
const cameraContainer = document.getElementById('cameraContainer');
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const photoFrame = document.getElementById('photoFrame');
const scanOverlay = document.getElementById('scanOverlay');
const scanText = document.getElementById('scanText');
const resultBox = document.getElementById('resultBox');

let stream = null;
let usingFrontCam = false;

/* DÃ©marre une camÃ©ra */
async function startCamera(){
  if (stream) stream.getTracks().forEach(t=>t.stop());

  const facing = usingFrontCam ? "user" : "environment";

  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:{ ideal: facing } },
      audio:false
    });

    video.srcObject = stream;
    video.addEventListener('loadedmetadata', onVideoMetadata);

  } catch(err){
    alert("Impossible dâ€™accÃ©der Ã  la camÃ©ra.");
    console.error(err);
  }
}

/* Bouton principal */
startBtn.addEventListener('click', async () => {
  cameraContainer.style.display = 'flex';
  startBtn.remove();
  await startCamera();
});

/* SWITCH CAMERA */
switchCamBtn.addEventListener("click", async () => {
  usingFrontCam = !usingFrontCam;  
  await startCamera();
});

/* Ajustements */
function onVideoMetadata(){
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  syncFrameToVideo();
}
window.addEventListener('resize', syncFrameToVideo);

function syncFrameToVideo(){
  const vw = video.videoWidth || 640;
  const vh = video.videoHeight || 480;
  const usedWidth = Math.min(photoFrame.parentElement.clientWidth, 920);
  const h = Math.round(usedWidth * vh / vw);
  photoFrame.style.width = usedWidth+"px";
  photoFrame.style.height = h+"px";
}

/* Capture */
captureBtn.addEventListener('click', () => {
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  canvas.style.display = 'block';
  video.style.display = 'none';

  captureBtn.style.display = 'none';
  switchCamBtn.style.display = 'none';
  analyzeBtn.style.display = 'inline-block';
});

/* Analyse */
let dotsInterval=null;

analyzeBtn.addEventListener('click', () => {
  analyzeBtn.remove();
  scanText.style.display = 'block';
  scanOverlay.style.display = 'block';
  startDots();

  startScanAnimation(() => {
    scanOverlay.innerHTML = '';
    scanText.style.display = 'none';
    stopDots();
    typeText(Reponse_IA);
  });
});

function startDots(){
  let dots = 0;
  dotsInterval = setInterval(()=>{
    dots = (dots+1)%4;
    scanText.textContent = "Analyse en cours" + ".".repeat(dots);
  },500);
}
function stopDots(){ clearInterval(dotsInterval); }

function startScanAnimation(done){
  const dirs = ['down','up','right','left'];
  let i = 0;

  function next(){
    if (i >= dirs.length) return done();

    scanOverlay.innerHTML = '';
    const line = document.createElement('div');
    line.className = 'line';
    scanOverlay.appendChild(line);

    let anim;
    switch (dirs[i++]){
      case 'down':
        line.style.width='100%'; line.style.height='6px'; line.style.top='0';
        anim = line.animate([{top:'0%'},{top:'100%'}],1000); break;
      case 'up':
        line.style.width='100%'; line.style.height='6px'; line.style.top='100%';
        anim = line.animate([{top:'100%'},{top:'0%'}],1000); break;
      case 'right':
        line.style.height='100%'; line.style.width='6px'; line.style.left='0';
        anim = line.animate([{left:'0%'},{left:'100%'}],1000); break;
      case 'left':
        line.style.height='100%'; line.style.width='6px'; line.style.left='100%';
        anim = line.animate([{left:'100%'},{left:'0%'}],1000); break;
    }
    anim.onfinish = next;
  }
  next();
}

/* Affichage texte IA */
function typeText(text){
  resultBox.style.display='block';
  resultBox.textContent='';
  let i=0;

  function step(){
    if (i < text.length){
      resultBox.textContent += text.charAt(i++);
      setTimeout(step, 40 + Math.random()*50);
    }
  }
  step();
}

/* Sauvegarde photo */
function getTimestampFilename(){
  const n = new Date();
  const p = v=>String(v).padStart(2,'0');
  return `${p(n.getDate())}${p(n.getMonth()+1)}${n.getFullYear()}${p(n.getHours())}${p(n.getMinutes())}${p(n.getSeconds())}.png`;
}
function downloadCapturedImage(){
  const a = document.createElement('a');
  a.href = canvas.toDataURL("image/png");
  a.download = getTimestampFilename();
  a.click();
}
resultBox.addEventListener('click', downloadCapturedImage);

window.addEventListener('beforeunload',()=>{ if (stream) stream.getTracks().forEach(t=>t.stop()); });

</script>


<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/BAIsilikDemo/sw.js");
}
</script>


</body>
</html>
